<!DOCTYPE HTML>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>high level bits - </title>
    <link href="http://fonts.googleapis.com/css?family=Iceland%7CVolkhov" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="awesome/font-awesome-min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="alternate" type="application/atom+xml" title="high level bits" href="atom.xml">

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="nanoc 3.6.2">

    <!-- google analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1370334-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <!-- end google analytics -->
  </head>
  <body>
    <div class="main">
      <div class="header">
        <div class="twitter-window">
          <a href="https://twitter.com/highlevelbits" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @highlevelbits</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        </div>
        <h1>h1ghlevelb1ts</h1>
      </div>
      <div class="menu">
        <a href="./">home</a>
        ·
        <a href="archive.html">archive</a>
        ·
        <a href="http://about.me/hardyferentschik">hardy</a>
        ·
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
      <div class="content">
        <div class="start-page">
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/10/single_point_logging.html">single point logging with go</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-10-03
      </div>
    </div>
    <p>I’ll continue to spam you with <a href="http://golang.org/">go</a> related posts. I am working on a rather small webapp built with go. Despite it being small we have still managed to code differently in different parts of the application. Logging is one such issue that we decided to do something about the other day. At the same time it was good to improve on the error handling which often goes hand in hand with logging. In the midst of this some external forces (operations….) tells us that we should use a <strong>logging server</strong> for logging. Not right away mayhaps but eventually. This led us to go for our own logging functions so that we can change the implementation in one place. So we needed to get some common things into the log. User name (or some way to keep track of one call to the system), a timestamp, the code line where the logging occurred and the message itself. A normal application log file more or less. </p>

<p>To call our own logger we thought something like <code>LogInfo(user User, message string, args... interface{})</code> looked nice with corresponding functions for Error and Debug. The first implementation was easy enough:</p>

<pre><code>func LogInfo(message string, args ...interface{}) {
  log.Printf("INFO | " + message, args...)
}
</code></pre>

<p>But wait? What happens with the code line number? It will point to our logger function and that is not what we intended. We would like the line nubmer to be where the call to LogInfo occurred. At this point in time it was very handy to have the source code available for the standard library. <code>Printf</code> does not care about line numbers and such - it just prints whatever line it is invoked on. Underneath the <code>Printf</code> function there are a <code>Logger</code> type that defines an <code>Output</code> function called by printf. So lets start with constructing a <code>Logger</code>:</p>

<pre><code>func Logger() *log.Logger {
  return log.New( os.Stderr, "", log.Lshortfile | log.Ldate | log.Ltime )
}
</code></pre>

<p>The first argument to <code>New</code> is a writer. For now we are happy to write to Stderr. The second is a prefix to use when logging - we don’t care about it now - probably useful when you log from several things to the same file. Lastly we tell the standard library what we want to log - a short file description with line number and a timestamp. Find the available options under the <em>const</em> part in the log package documentation. Now all we need to do is to call the <code>Output</code> function on the logger.</p>

<pre><code>func LogInfo(message string, args ...interface{}) {
  calldepth := 3 // the distance to the actual call for logging
  Logger().Output(calldepth, "INFO | " + fmt.Sprintf(message, args...))
}
</code></pre>

<p>and use it to log some stuff:</p>

<pre><code>LogInfo("%s %s", "some", "stuff")
</code></pre>

<p>The <code>calldepth</code> here is basically what part of the stack that makes it as a code line into the block. The standard library uses 2 so it made sense to add one to get to the right position for us. The standard library uses <code>runtime.Caller</code> to get to this information. There are other functions to get to the stack also in the <code>runtime</code> package.</p>

<p>In the real world we passed in info about our user, extracted log message creation to its own function and added functions for error and debug. We also had one set of functions accepting a user and one set not accepting a user. We also did <a href="http://stackoverflow.com/q/19115273/135673">some thinking</a> about if it was possible to log something like a thread id and came to the conclusion that it isn’t possible in go. I got a <a href="http://stackoverflow.com/a/19116962/135673">nice answer</a> from <a href="http://stackoverflow.com/users/41344/rog">rog</a> and here is the first part:</p>

<blockquote>
  <p>Because of the high potential for abuse, there is no way to access an identifier for the current goroutine in Go. This may 
seem draconian, but this actually preserves an important property of the Go package ecosystem: <em>it does not matter if you 
start a new goroutine to do something</em>.</p>
</blockquote>

<p>A good explanation and in line with the go way of doing things. I can find it a bit limiting at times but it is almost always for a good reason which makes it easier to accept.</p>

<p>As a side note - the go community is very helpful. Using the #golang tag on twitter for asking questions renders some nice answers and discussions. Very useful. And <a href="http://stackoverflow.com">stackoverflow</a> is a good resource as always.</p>
    <center>
      ------
    </center>
    <div class="outro">
      <i>
        Even though this was the entire post you may want to leave a comment on the
        <a href="2013/10/single_point_logging.html">post page</a>
        .
      </i>
    </div>
  </div>
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/09/go_error_handling_thoughts.html">thoughts about error handling with go</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-09-30
      </div>
    </div>
    <p>I find myself with this code line lots of time:</p>

<pre><code>if err != nil { return err }
</code></pre>

<p>Sometimes with an extra return value - sometimes not. However - the go formatter likes it to be:</p>

<pre><code>if err != nil {
    return err
}
</code></pre>

<p>which is my preferred way to write it normally. Now I have started to use the one-liner approach to make my code more readable. In a simple database sequence you may need to check the error 3 or more times (getting the database, executing the query and scanning the response for data) so the error handling <em>noise</em> will be 3 or 9 lines of such a function. In my mind there is a conflict between explicit code and readable code. Go seems to drive me towards explicit code forcing me to leave some of my coding practices behind.</p>

<p>Please contribute your thoughts about this in the comments section below.</p>
    <center>
      ------
    </center>
    <div class="outro">
      <i>
        Even though this was the entire post you may want to leave a comment on the
        <a href="2013/09/go_error_handling_thoughts.html">post page</a>
        .
      </i>
    </div>
  </div>
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/09/golang_templating_engine.html">go templating - the basics</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-09-28
      </div>
    </div>
    <p><a href="http://www.flickr.com/photos/29363671@N08/4264734398"><img style="float:right" src="http://farm3.staticflickr.com/2723/4264734398_f89371801a.jpg"></a></p>

<p>I am busy coding a web site with <a href="http://golang.org/">go</a>. I am still not convinced that go is the best choice for web development unless performance is in high demand. It is still great fun to learn a new language and a language that have different opinions on many things compared to other languages. This kind of experiences are very good to move forward as a developer. So kudos to <a href="http://www.flatwallet.se/">flatwallet</a> that lets me learn go while getting paid for it. </p>

<p>We try to use as much as possible of the standard library but sometimes it is hard as I <a href="http://highlevelbits.com/2013/09/pragmatic_unit_testing_with_go.html">described in my post about testing</a>. When it comes to web development there is a good enough <a href="http://golang.org/pkg/text/template/">template engine</a> that provides with the simplest things to get stuff into your <a href="http://highlevelbits.com/2012/04/control-your-markup.html">markup</a>. In mainstream template engines the normal way to get behavior into your template is to use <code>&lt;% %&gt;</code> for executing some code and <code>&lt;%= %&gt;</code> for getting some stuff inserted into the generated markup. In go you use double curly braces instead. So in order to insert a value you go <code>{{.Value}}</code>. The single point is a reference to the data structure (remember - no objects in go) that was passed to the template from the back end code and value is a field in that structure. There is the basic control flow things like:</p>

<pre><code>{{ if .IsActive }}
  Active
{{ else }}
  Inactive
{{ end }}
</code></pre>

<p>and loops:</p>

<pre><code>{{ range .Books }}
  &lt;div&gt;
    {{ .Title }} by {{ .Author }}
  &lt;/div&gt;
{{ end }}
</code></pre>

<p>When using <code>range</code> the <code>.</code> context is set to the current item for each loop over the collection. As you see you just mix curly braces with HTML freely. (So that it looks really messy to the eye….) Since the templating doesn’t conflict with the markup you can also use them in attribute values. This may look nasty at times:</p>

<pre><code>&lt;div class="{{if .IsActive}}active{{else}}passive{{end}}"/&gt;
</code></pre>

<p>Not to my liking. The alternative is to add another field to the page structure and calculate the value in the go code instead. It adds a bit of duplication and the number of line increases and I am not sure the overall readability goes up. So the above may actually be a good choice at times. In this particular case it has the benefit of keepin css classes in the markup. Indeed - you could do it like this just as well:</p>

<pre><code>{{ if .IsActive }}
  &lt;div class="active"/&gt;
{{ else }}
  &lt;div class="passive"/&gt;
{{ end }}
</code></pre>

<p>Better or worse? This is a simple div with nothing else in it but consider a real world situation where there are some content inside etc. Then it may be better to go with the compact solution instead. Things like these may be good to put in the coding guidelines for a project. (You all do them - right?!?)</p>

<p>You can define a template with <code>{{ define "my_template" }} &lt;html&gt;....&lt;/html&gt; {{ end }}</code> for both whole pages and parts in a page. Say you define a header partial: <code>{{ define "header" }}&lt;div&gt;Menus and other header stuffs.&lt;/div&gt;{{ end }}</code> then you can use it in another template with: <code>{{ template "header" }}</code>. So that is kind of neat. There is no support for layouts so for solving that in the standard library way you’ll have to do it yourself with functions calling different templates in different contexts. </p>

<p>One more thing. You can use <code>with</code> to get deeper in the context of the page. Like this:</p>

<pre><code>{{ range .Books }}
  &lt;div&gt;
    {{ .Title }} by 
    {{ with .Author }}
      {{ .FirstName }}{{ .LastName }}
    {{ end }}
  &lt;/div&gt;
{{ end }}
</code></pre>

<p>I haven’t used this much but it has the benefit of getting evaluated only if there is something in the referenced value. So it is a combined <code>if</code> statement with a scope narrower.</p>

<p>Then there is a bunch of built-in functions that makes life a bit easier. The one that has bothered me most is <code>call</code> that lets you call a function from within the template. But not any function. It must either have been previously tied to the template with calls to <code>Funcs</code> with a <code>FuncMap</code> or be in the global namespace. So if you have a nice little function tied to the struct you are exposing to your template you can not use it right away. I find this limiting - the extra code to set it up can just as well be used to introduce another variable in the struct that holds the computed value. You end up with redundant data in your model where parts are ‘real’ data and parts are computed values. I don’t have a perfect <em>feel</em> for this yet and will come back to review it later and maybe another post about advanced templating.</p>

<p>The standard library documentation is really good. The templating basics is in the <a href="http://golang.org/pkg/text/template/">text/template package</a> while there are some added things for web pages in the <a href="http://golang.org/pkg/text/template/">html/template package</a>. This separation is obviously good so that you can do templating inside whatever format you work with.</p>

<p>Engine photo by <a href="http://www.flickr.com/photos/29363671@N08/">Jon Pekelnicky</a>.</p>
    <center>
      ------
    </center>
    <div class="outro">
      <i>
        Even though this was the entire post you may want to leave a comment on the
        <a href="2013/09/golang_templating_engine.html">post page</a>
        .
      </i>
    </div>
  </div>
</div>

      </div>
      <div class="footer">
        high level bits was brought to you by
        <a href="http://about.me/hardyferentschik">hardy</a>
        and
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
    </div>
  </body>
</html>
