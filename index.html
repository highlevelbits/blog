<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>high level bits - </title>
<link href="http://fonts.googleapis.com/css?family=Iceland%7CVolkhov" rel="stylesheet" type="text/css">
<link href="awesome/font-awesome-min.css" rel="stylesheet">
<link href="style.css" rel="stylesheet">
<link href="forms.css" rel="stylesheet">
<link rel="alternate" type="application/atom+xml" title="high level bits" href="atom.xml">
<!-- you don't need to keep this, but it's cool for stats! --><meta name="generator" content="nanoc 3.6.5">
<!-- google analytics --><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1370334-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script><!-- end google analytics -->
</head>
<body>
    <div class="main">
      <div class="header">
        <div class="twitter-window">
          <a href="https://twitter.com/highlevelbits" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @highlevelbits</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
        <h1>h1ghlevelb1ts</h1>
      </div>
      <div class="menu">
        <a href="./">home</a>
        ·
        <a href="archive.html">archive</a>
        ·
        <a href="http://about.me/hardyferentschik">hardy</a>
        ·
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
      <div class="content">
        <div class="start-page">
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/11/china.html">visions of china</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-11-03
      </div>
    </div>
  </div>
  <p><img src="http://farm9.staticflickr.com/8465/8372395689_1a5a353bc8_b.jpg" alt=""></p>

<p>I like numbers. This is why I often sneak into <a href="http://www.flickr.com/photos/froderik/">my flickr account</a> and look at statistics. I have had an account for almost 8 years and there has beeen som 230000 views of my almost 8500 photos. And the more photos I put up - the more views I get. The other day I got interested in a peak on 30th of october with 1622 views and I found out that a picture (shown above) I took from the dragon tower in <a href="https://en.wikipedia.org/wiki/Harbin">Harbin</a> (China) last christmas had been used in <a href="http://www.theverge.com/2013/10/30/5042534/daan-roosegaarde-vacuum-looks-to-sweep-away-china-smog-in-beijing">a <strong>the verge</strong> post</a> about the chinese smog problem. Fun! I really liked the dreamy views from up the tower created by the cold -30 degrees celsius and the coal factories. Cold and cool….</p>

<p>Another shot I am happy with is this night time view of the main railway station in Harbin.</p>

<p><img src="http://farm9.staticflickr.com/8354/8373376294_4aac9d57ba_b.jpg" alt=""></p>

<p>Some <a href="http://www.flickr.com/search/?w=36307913@N00&amp;q=harbin">more photos</a> from our days in Harbin including many of ice sculptures.</p>

<p>From Harbin we got to Beijing by train. We only had two days there but still enough to get a good view of the forbidden palace and the wall. We had some luck with the weather the day when <a href="http://www.flickr.com/search/?w=36307913@N00&amp;q=great%20wall">we went out to the wall</a> - cold and sunny!</p>

<p><img src="http://farm9.staticflickr.com/8214/8441104536_a18c490d83_b.jpg" alt=""></p>

<p>Our visit to the forbidden palace was in very cloudy weather so no nice pictures from there. Night time in the old parts of Beijing on the other hand is something extra. It is rather dark - not much street lihtning but you still fell safe. Probably because there are much people around. The photo below is from a restaurant street where we had some nice hot pot!</p>

<p><img src="http://farm9.staticflickr.com/8193/8440607785_e90fb36635_b.jpg" alt=""></p>

<p>For more chinese goodness you can browse all <a href="http://www.flickr.com/search/?w=36307913@N00&amp;q=china">my photos from China</a>.</p>
  <center>
    ------
  </center>
  <div class="outro">
    <i>
      Even though this was the entire post you may want to leave a comment on the
      <a href="2013/11/china.html">post page</a>
      .
    </i>
  </div>
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/10/multiple_fields_validation.html">multiple fields validation with javascript</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-10-15
      </div>
    </div>
  </div>
  <p>
  I have encountered one particular kind of requirement several times now and made a couple of different implementations of it. This last implementation is generic and can be reused in several places. The task is to make a form submit button active only when all fields in a form validates. It helps the user to understand that they have entered something wrong without the roundtrip to a server. It should be combined with useful error messages next to the fields but I won't go in to that now.
</p>
<p>
  In the form below there are 3 different inputs with different validation requirements and the submit button only activates when all of them are validated. There need to be something in the text area and the date and time fields should be on the format dddd-dd-dd and dd:dd and only then will the button become activated.
</p>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
<script>&#x000A;  function buttonEnabling(buttonSelector, isEnabled){&#x000A;    if(isEnabled) {&#x000A;      $(buttonSelector).removeAttr("disabled");&#x000A;    } else {&#x000A;      $(buttonSelector).attr("disabled", "disabled")&#x000A;    }&#x000A;  }&#x000A;  &#x000A;  function validateFields(selectorsWithFunctions, buttonSelector) {&#x000A;    var isValid = true&#x000A;    for (var i = selectorsWithFunctions.length - 1; i >= 0; i--) {&#x000A;      var selector = selectorsWithFunctions[i][0];&#x000A;      var func = selectorsWithFunctions[i][1];&#x000A;  &#x000A;      if( !func(selector) ) {&#x000A;        isValid = false;&#x000A;        break;&#x000A;      }&#x000A;    };&#x000A;    buttonEnabling(buttonSelector, isValid);&#x000A;  }&#x000A;  &#x000A;  function validateTime(selector) {&#x000A;    var fieldValue = $(selector).val();&#x000A;    return /^\d\d:\d\d$/.test(fieldValue.trim());&#x000A;  }&#x000A;  &#x000A;  function validateDate(selector) {&#x000A;    var fieldValue = $(selector).val();&#x000A;    return /^\d\d\d\d-\d\d-\d\d$/.test(fieldValue.trim());&#x000A;  }&#x000A;  &#x000A;  function validatePresence(selector) {&#x000A;    var fieldValue = $(selector).val();&#x000A;    return fieldValue.length > 0&#x000A;  }&#x000A;  &#x000A;  function runFieldValidations() {&#x000A;    validators = [&#x000A;      ["#some-text", validatePresence],&#x000A;      ["#date", validateDate],&#x000A;      ["#time", validateTime]&#x000A;    ];&#x000A;    validateFields(validators, "#submit-button")&#x000A;  }&#x000A;  &#x000A;  $(document).ready(function(){&#x000A;    $("#some-text").keyup(runFieldValidations);&#x000A;    $("#date").keyup(runFieldValidations);&#x000A;    $("#time").keyup(runFieldValidations);&#x000A;    runFieldValidations();&#x000A;  });&#x000A;</script>
<p>
  </p>
<form>
    <div class="form-row">
      <div class="label">
        <label>
          Some mandatory text
        </label>
      </div>
      <textarea id="some-text"></textarea>
    </div>
    <div class="form-row">
      <div class="label">
        <label>
          A date (yyyy-mm-dd)
        </label>
      </div>
      <input id="date" type="text">
    </div>
    <div class="form-row">
      <div class="label">
        <label>
          A time (hh:mm)
        </label>
      </div>
      <input id="time" type="text">
    </div>
    <div class="form-row">
      <input disabled id="submit-button" type="submit">
    </div>
  </form>

<p>
  Lets go top down through the code that does this. I am using jquery in the example but it shouldn't be a problem doing the same thing with vanilla javascript or your framework of choice. First - set up event listeners on keyboard events triggered in our 3 widgets. (Widgets! Sound of the 90s!) For this the ready function of jquery is convenient:
</p>
<pre><code>$(document).ready(function(){
  $("#some-text").keyup(runFieldValidations);
  $("#date").keyup(runFieldValidations);
  $("#time").keyup(runFieldValidations);
  runFieldValidations();
}</code></pre>
<p>
  Three widgets means three event bindings to the function
  <code>runFieldValidations</code>
  that does the actual validations. Finally it is called once to make sure the button is in the correct state when entering the document. If it has been disabled to start with we can still end up with a bit of data entered by the browser from a previous session. The runFieldValidations function takes care of setting up the validation used for each widget.
</p>
<pre><code>  function runFieldValidations() {
    validators = [
      ["#some-text", validatePresence],
      ["#date", validateDate],
      ["#time", validateTime]
    ];
    validateFields(validators, "#submit-button")
  }</code></pre>
<p>
  It calls a generic function called
  <code>validateFields</code>
  that accepts an array of tuples each of which is a css selector (pointing to the widget we want to validate) and a function that should be called to validate it. As its second argument it accepts a css selector for the button that is to be (dis|en)abled. It loops over the tuples and calls the function to decide if the validation passes or not. As soon as something doesn't validate it breaks out of the loops and disables the button. In my first version button enabling was inline in the function but I decided that breaking it out would increase readability. The button enabling itself is as easy as setting or removing the attribute disabled.
</p>
<pre><code>function buttonEnabling(buttonSelector, isEnabled){
  if(isEnabled) {
    $(buttonSelector).removeAttr("disabled");
  } else {
    $(buttonSelector).attr("disabled", "disabled")
  }
}

function validateFields(selectorsWithFunctions, buttonSelector) {
  var isValid = true
  for (var i = selectorsWithFunctions.length - 1; i &gt;= 0; i--) {
    var selector = selectorsWithFunctions[i][0];
    var func = selectorsWithFunctions[i][1];

    if( !func(selector) ) {
      isValid = false;
      break;
    }
  };
  buttonEnabling(buttonSelector, isValid);
}</code></pre>
<p>
  This is the engine of the solution. Now the only thing left is to show the functions that does the actual validation. They accept a selector and does some easy checking on the value. In the date and time cases this is done with regular expressions. They look like this:
</p>
<pre><code>function validateTime(selector) {
  var fieldValue = $(selector).val();
  return /^\d\d:\d\d$/.test(fieldValue.trim());
}

function validateDate(selector) {
  var fieldValue = $(selector).val();
  return /^\d\d\d\d-\d\d-\d\d$/.test(fieldValue.trim());
}

function validatePresence(selector) {
  var fieldValue = $(selector).val();
  return fieldValue.length &gt; 0
}</code></pre>
<p>
  I am actually getting to like Javascript. It is rather easy to create small lightweight pieces of code. In this example we send around pointers to functions (a language feature that made this blog post possible). I think many script developers lack a bit in discipline and end up with high complexity and low readability. But this is clearly not the fault of javascript. As always - with higher levels of freedom comes a greater burden of responsibility.
</p>
  <center>
    ------
  </center>
  <div class="outro">
    <i>
      Even though this was the entire post you may want to leave a comment on the
      <a href="2013/10/multiple_fields_validation.html">post page</a>
      .
    </i>
  </div>
  <div class="start-page-article">
    <div class="row">
      <h2 class="article-header">
        <a href="2013/10/single_point_logging.html">single point logging with go</a>
      </h2>
      <div class="byline">
        by
        fredrik
        on
        2013-10-03
      </div>
    </div>
  </div>
  <p>I’ll continue to spam you with <a href="http://golang.org/">go</a> related posts. I am working on a rather small webapp built with go. Despite it being small we have still managed to code differently in different parts of the application. Logging is one such issue that we decided to do something about the other day. At the same time it was good to improve on the error handling which often goes hand in hand with logging. In the midst of this some external forces (operations….) tells us that we should use a <strong>logging server</strong> for logging. Not right away mayhaps but eventually. This led us to go for our own logging functions so that we can change the implementation in one place. So we needed to get some common things into the log. User name (or some way to keep track of one call to the system), a timestamp, the code line where the logging occurred and the message itself. A normal application log file more or less. </p>

<p>To call our own logger we thought something like <code>LogInfo(user User, message string, args... interface{})</code> looked nice with corresponding functions for Error and Debug. The first implementation was easy enough:</p>

<pre><code>func LogInfo(message string, args ...interface{}) {
  log.Printf("INFO | " + message, args...)
}
</code></pre>

<p>But wait? What happens with the code line number? It will point to our logger function and that is not what we intended. We would like the line nubmer to be where the call to LogInfo occurred. At this point in time it was very handy to have the source code available for the standard library. <code>Printf</code> does not care about line numbers and such - it just prints whatever line it is invoked on. Underneath the <code>Printf</code> function there are a <code>Logger</code> type that defines an <code>Output</code> function called by printf. So lets start with constructing a <code>Logger</code>:</p>

<pre><code>func Logger() *log.Logger {
  return log.New( os.Stderr, "", log.Lshortfile | log.Ldate | log.Ltime )
}
</code></pre>

<p>The first argument to <code>New</code> is a writer. For now we are happy to write to Stderr. The second is a prefix to use when logging - we don’t care about it now - probably useful when you log from several things to the same file. Lastly we tell the standard library what we want to log - a short file description with line number and a timestamp. Find the available options under the <em>const</em> part in the log package documentation. Now all we need to do is to call the <code>Output</code> function on the logger.</p>

<pre><code>func LogInfo(message string, args ...interface{}) {
  calldepth := 3 // the distance to the actual call for logging
  Logger().Output(calldepth, "INFO | " + fmt.Sprintf(message, args...))
}
</code></pre>

<p>and use it to log some stuff:</p>

<pre><code>LogInfo("%s %s", "some", "stuff")
</code></pre>

<p>The <code>calldepth</code> here is basically what part of the stack that makes it as a code line into the block. The standard library uses 2 so it made sense to add one to get to the right position for us. The standard library uses <code>runtime.Caller</code> to get to this information. There are other functions to get to the stack also in the <code>runtime</code> package.</p>

<p>In the real world we passed in info about our user, extracted log message creation to its own function and added functions for error and debug. We also had one set of functions accepting a user and one set not accepting a user. We also did <a href="http://stackoverflow.com/q/19115273/135673">some thinking</a> about if it was possible to log something like a thread id and came to the conclusion that it isn’t possible in go. I got a <a href="http://stackoverflow.com/a/19116962/135673">nice answer</a> from <a href="http://stackoverflow.com/users/41344/rog">rog</a> and here is the first part:</p>

<blockquote>
  <p>Because of the high potential for abuse, there is no way to access an identifier for the current goroutine in Go. This may 
seem draconian, but this actually preserves an important property of the Go package ecosystem: <em>it does not matter if you 
start a new goroutine to do something</em>.</p>
</blockquote>

<p>A good explanation and in line with the go way of doing things. I can find it a bit limiting at times but it is almost always for a good reason which makes it easier to accept.</p>

<p>As a side note - the go community is very helpful. Using the #golang tag on twitter for asking questions renders some nice answers and discussions. Very useful. And <a href="http://stackoverflow.com">stackoverflow</a> is a good resource as always.</p>
  <center>
    ------
  </center>
  <div class="outro">
    <i>
      Even though this was the entire post you may want to leave a comment on the
      <a href="2013/10/single_point_logging.html">post page</a>
      .
    </i>
  </div>
</div>

      </div>
      <div class="footer">
        high level bits was brought to you by
        <a href="http://about.me/hardyferentschik">hardy</a>
        and
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
    </div>
  </body>
</html>
