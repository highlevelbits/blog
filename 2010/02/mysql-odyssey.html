<!DOCTYPE HTML>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>high level bits - A MySQL odyssey</title>
<link href="http://fonts.googleapis.com/css?family=Iceland%7CVolkhov" rel="stylesheet" type="text/css">
<link href="../../awesome/font-awesome-min.css" rel="stylesheet">
<link href="../../style.css" rel="stylesheet">
<link href="../../forms.css" rel="stylesheet">
<link rel="alternate" type="application/atom+xml" title="high level bits" href="../../atom.xml">
<!-- you don't need to keep this, but it's cool for stats! --><meta name="generator" content="nanoc 3.6.8">
<!-- google analytics --><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1370334-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script><!-- end google analytics -->
</head>
<body>
    <div class="main">
      <div class="header">
        <div class="twitter-window">
          <a href="https://twitter.com/highlevelbits" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @highlevelbits</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
        <h1>h1ghlevelb1ts</h1>
      </div>
      <div class="menu">
        <a href="../../">home</a>
        ·
        <a href="../../archive.html">archive</a>
        ·
        <a href="http://about.me/hardyferentschik">hardy</a>
        ·
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
      <div class="content">
        <h2 class="article-header">
  A MySQL odyssey
</h2>
<span class="byline">2010-02-09 by hardy</span>

  <span class="tags">
    
      <a class="one-tag" href="../../tags/mysql.html"><span class="icon-tag"></span>mysql</a>
    
      <a class="one-tag" href="../../tags/rails.html"><span class="icon-tag"></span>rails</a>
    
  </span>

I just started a little side project using <a href="http://rubyonrails.org/">Ruby on Rails</a> and decided today to start developing against the database I will be using in production - <a href="http://www.mysql.com/">MySQL</a>. So far I have been using <a href="http://www.sqlite.org/">SQLite</a> which worked fine, but it is always good to stay as close as possible to the target environment as possible. Anyways, let my odyssey begin...<br>In theory I just have to edit <span style="font-style: italic;">config/database.yml</span> and change the adapter parameter to <span style="font-style: italic;">mysql</span>. Then restart the rails server <span style="font-style: italic;">script/server -e development</span>. Done!<br>Well, not so fast. The first restart tells me that mysql is not part of the default rails application anymore. The error message is quite clear and basically recommend to just run<span style="font-style: italic;"> gem install mysql</span>. Fair enough, I run the gem install and restart the server. Now I get:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>&gt; script/server -e development<br><br>=&gt; Rails 2.3.4 application starting on http://0.0.0.0:3000<br>/Users/hardy/.gem/ruby/1.8/gems/radiant-0.8.1/vendor/rails/activesupport/lib/active_support/dependencies.rb:440:in `load_missing_constant': uninitialized constant MysqlCompat::MysqlRes (NameError)<br></code></pre>Ok, not so funny anymore and quite cryptic. Uninitialized constant that cannot be good.<br>A word to my environment. I run Max OS X (Snow Lepard) on a Mac Book Pro. MySQL is installed via <a href="http://www.macports.org/">MacPorts</a> and can be found somewhere under <span style="font-style: italic;">/opt/local</span>. The MySQL version is 5.1.40.<br>What does one do in such a situation? I start googling and end up in some cryptic mail archives. Bugger, worst case scenario. Digging through mail archives is a real pita. Information is often unverified and skimming through through a million <span style="font-style: italic;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> is just no fun. After some searching I suspect that the problem I am experiencing is that the mysql gem needs to be build for 64 bit. I decide to try:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>sudo env ARCHFLAGS="-arch x86_64" gem install mysql –with-mysql-config=/opt/local/lib/mysql5/bin/mysql_config<br></code></pre>After that I start the server again. This time I get:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>/Users/hardy/.gem/ruby/1.8/gems/radiant-0.8.1/vendor/rails/activerecord/lib/active_record/connection_adapters/mysql_adapter.rb:585:in `real_connect': Can't connect to local MySQL server through socket '/opt/local/var/run/mysql5/mysqld.sock' (2) (Mysql::Error)<br></code></pre>Argh, another error. At least it is something more familiar. MySQL lets you either connect via TCP/IP or via Unix sockets. But why does it try to via <span style="font-style: italic;">/opt/local/var/run/mysql5/mysqld.sock</span>. I am pretty sure I am using a different socket file. I locate my MySQL config file and find that the socket file is <span style="font-style: italic;">/tmp/mysql.sock. </span>Why did that not get picked up? I add:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>socket: /tmp/mysql.sock<br></code></pre>to my <span style="font-style: italic;">config/database.yml</span><span>. One restart later and I get:</span><br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>/Users/hardy/.gem/ruby/1.8/gems/radiant-0.8.1/vendor/rails/activerecord/lib/active_record/connection_adapters/mysql_adapter.rb:585:in `real_connect': Access denied for user 'foobar'@'localhost' (using password: YES) (Mysql::Error)<br></code></pre>Will this never end? At least it's another classic. MySQL permissions. First step is always the <span style="font-style: italic;">mysql.user</span> table. I probably forgot to add an entry for my user and database. I connect as root and execute:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>CREATE USER 'johndoe'@'localhost' IDENTIFIED BY 'foobar';<br>GRANT ALL PRIVILEGES ON mydb.* TO 'johndoe'@'localhost' WITH GRANT OPTION;<br></code></pre>After that I try to start the ruby server again. Same problem. Some quick swearing, but then I remember - flush! Back to the mysql shell:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>FLUSH PRIVILEGES;<br></code></pre>And now I get an error in the mysql shell:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>Table 'mysql.servers' doesn't exist<br></code></pre>
<span style="font-weight: bold;">WTF!</span> After some more swearing (this time in German) I start googling again. I cannot find a reasonable explanation on why this table is needed or why it is not created in my <span style="font-style: italic;">mysql</span> database. Best I find is a table creation script which I decide to run:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>CREATE TABLE `servers` (<br>`Server_name` char(64) NOT NULL,<br>`Host` char(64) NOT NULL,<br>`Db` char(64) NOT NULL,<br>`Username` char(64) NOT NULL,<br>`Password` char(64) NOT NULL,<br>`Port` int(4) DEFAULT NULL,<br>`Socket` char(64) DEFAULT NULL,<br>`Wrapper` char(64) NOT NULL,<br>`Owner` char(64) NOT NULL,<br>PRIMARY KEY (`Server_name`)<br>) ENGINE=MyISAM DEFAULT CHARSET=utf8 COMMENT='MySQL Foreign Servers table';<br></code></pre>Ahh, now flushing privileges works. One more  <span style="font-style: italic;">script/server -e development - </span><span><span style="font-weight: bold;">success!</span></span> Finally I am up and running again, but I wonder:"Do things really have to be so painful?"<br><br>--Hardy<br><br>P.S.: With MySQL permission/user problems I recommend to go through these guides: <a href="http://dev.mysql.com/doc/refman/5.0/en/access-denied.html">access- denied</a> and <a href="http://dev.mysql.com/doc/refman/5.1/en/adding-users.html">adding-users</a>.<br><br>P.S.S: Another problem which had me puzzled for a while one was that I was not able connect to MySQL using:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>mysql5 -u foobar -p<br></code></pre>Whenever I tried to connect with a password I would get the <span style="font-style: italic;">Access denied for user (using password: YES)</span> error. Connecting without the -p option worked though. I kept looking at the <span style="font-style: italic;">mysql.user</span> table and the entry for foobar. What I did not notice was that I had effectively something like this:<br><pre style="border: 1px dashed rgb(153, 153, 153); padding: 5px; overflow: auto; font-family: Andale Mono,Lucida Console,Monaco,fixed,monospace; color: rgb(0, 0, 0); background-color: rgb(238, 238, 238); font-size: 12px; line-height: 14px; width: 100%;"><code>Host       User      Password       <br>localhost <br>%          foobar    <password><br></password></code></pre>The first line allows any user to connect from localhost using no password. Since localhost is more specific then the % wildcard this rule was always applied before the actual foobar entry.<div class="old-comments">
<h2>Old comments</h2>
<div class="one-old-comment">
<span class="comment-date">2011-09-01</span><span class="commenter-name">Albert Chou</span><div class="comment-body">It's no wonder why MySQL is no longer the default database type in Rails. After having the mysql.sock file problem spontaneously today, I'm seriously wondering whether PostgreSQL ever has such maddening problems. MySQL, especially on a freshly installed machine, seems to consistently throw up the same set of roadblocks for everyone.</div>
</div>
</div>

<div class="dashed-top-border">
  <!-- disqus -->
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'highlevelbits'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  <!-- end disqus -->
</div>

      </div>
      <div class="footer">
        high level bits was brought to you by
        <a href="http://about.me/hardyferentschik">hardy</a>
        and
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
    </div>
  </body>
</html>
