<!DOCTYPE HTML>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>high level bits - Bash magic</title>

    <link href="https://fonts.googleapis.com/css?family=Iceland%7CVolkhov" rel="stylesheet" type="text/css">

    <link href="../../awesome/font-awesome-min.css" rel="stylesheet">
    <link href="../../style.css" rel="stylesheet">
    <link href="../../forms.css" rel="stylesheet">

    <link rel="alternate" type="application/atom+xml" title="high level bits" href="../../atom.xml">

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="nanoc 4.1.1">
      
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  </head>
  <body>
    <div class="main">
      <div class="header">
        <a href="../../">
          <h1>h1ghlevelb1ts</h1>
        </a>
      </div>
      <div class="menu">
        <a href="../../">home</a>
        ·
        <a href="../../archive.html">archive</a>
      </div>
      <div class="content">
        <h2 class="article-header">
  Bash magic
</h2>
<div>
  <span class="byline">2015-08-05 by fredrik</span>
  
    <span class="tags">
      
        <a class="one-tag" href="../../tags/bash.html" rel="tag"><span class="icon-tag"></span>bash</a>
      
    </span>
  
</div>
<div class="inner-content">

<p>Recently I found myself with the task of writing a database script to update some stuff in production. 
Since I have no power over the machine in question I decided to do it in bash. While doing it I picked
up a couple of new spells that needed to be documented somehwere. Like here!</p>

<p><img src="https://farm5.staticflickr.com/4116/4814208649_a9ce8c8e72_b.jpg" alt=""></p>

<h3 id="redirection-in-general">Redirection in general</h3>

<p>I normally use mostly the fist one to get stuff into a file but got into some problems. It turned out that 
a single <code>&gt;</code> overwrites the argument file while <code>&gt;&gt;</code> appends to it. Since I was looping over values and 
appending them to a result file the second option worked this time. I also cut and pasted a usage of <code>&lt;&lt;&lt;</code> when
sending the result of a command to a <code>read</code> command. I am still not entirely sure about what this is.
Lots of information about <a href="http://wiki.bash-hackers.org/syntax/redirection">redirection</a> can be found
in the <a href="http://wiki.bash-hackers.org">Bash Hackers Wiki</a> (an overall good resource on bash - 
stackoverflow does not rule everywhere yet).</p>

<h3 id="redirecting-a-file-into-a-while-loop-using-read-for-iterations">Redirecting a file into a while loop using read for iterations</h3>

<p>It is possible to send a file into a while loop like this:</p>

<pre><code>while read X Y Z 
do
    # do stuff with X, Y and Z
end &lt; datafile.csv
</code></pre>

<p>This will read a 3 column tab separated file one line at a time into the X, Y and Z variables.
The read command default to tab separation. It is possible to set another separator with the 
<code>IFS</code> env variable. I had some problem running this on older versions of bash (production….) so
I abandoned it and converted data to tab sepearated files again. With bash 4.3 on Mint the IFS 
way of doig it works fine.</p>

<h3 id="splitting-data">Splitting data</h3>

<p>The <code>read</code> command is generally cool. It can split any data into parts. Above it is used to get values from
a tab separated file inside a while loop criteria. I also used it for splitting
the result of a <code>grep</code> command:</p>

<pre><code>read -r X Y &lt;&lt;&lt; `grep ^value, file`
</code></pre>

<p>Of course - in this case you need to be sure that there will be only one hit from the grep command.</p>

<h3 id="tab-characters">Tab characters….</h3>

<p>…can be hard to work with. When greping on something with a tab character it is useful to use the 
perl style regexp:</p>

<pre><code>grep -P "stuff\tfluff" file
</code></pre>

<p>And outputting tab files also needs some special treatment:</p>

<pre><code>echo -e "stuff\tfluff"
</code></pre>

<h3 id="sql-variables">SQL variables</h3>

<p>I learned that it is possible to select into a variable. For example the last insert id could be useful to 
have around for other queries.</p>

<pre><code>BEGIN;
INSERT INTO stuff VALUES(null, 1, 2, 3);
SELECT last_insert_id() INTO @id;
INSERT INTO FLUFF VALUES(@id, 5, 6, 7);
COMMIT;
SELECT @id;
</code></pre>

<p>and as you see you can also select it directly. When called in a bash script you can then save it into a variable
to use for logging or further processing.</p>

<p>Well that is about it for now. Happy bashing bashers!</p>

<p>Photo credit to <a href="https://www.flickr.com/photos/jm3/4814208649">jm3 of flickr</a>.</p>

</div>

      </div>
      <div class="footer">
        high level bits was brought to you by
        <a href="http://about.me/hardyferentschik">hardy</a>
        and
        <a href="http://about.me/fredrik.rubensson">fredrik</a>
      </div>
    </div>
  </body>
</html>
